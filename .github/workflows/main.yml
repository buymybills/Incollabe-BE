name: Main CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - dev

jobs:
  # Detect which services have changed
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      incollab: ${{ steps.changes.outputs.incollab }}
      # any-service: ${{ steps.changes.outputs.any-service }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper diff

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            incollab:
              - 'incollab/**'
              - 'src/**'
              - 'package.json'
              - 'Dockerfile'
              - 'docker-compose.yml'
              - 'nginx.conf'
              - '.env'
              - '.github/workflows/**'


  # Incollab Pipeline - Dev Branch
  incollab-build-dev:
    name: Build Incollab (Dev)
    if: needs.detect-changes.outputs.incollab == 'true' && github.ref == 'refs/heads/dev'
    needs: detect-changes
    uses: ./.github/workflows/build.yml
    with:
      service: "incollab"
      dockerfile_path: "./Dockerfile"
      context_path: "."

  incollab-test-dev:
    name: Test Incollab (Dev)
    if: needs.detect-changes.outputs.incollab == 'true' && github.ref == 'refs/heads/dev'
    needs: [detect-changes, incollab-build-dev]
    uses: ./.github/workflows/test.yml
    with:
      service: "incollab"
      service_path: "."
      node_version: "18"

  incollab-push-dev:
    name: Push Incollab (Dev)
    if: needs.detect-changes.outputs.incollab == 'true' && github.ref == 'refs/heads/dev'
    needs: [detect-changes, incollab-test-dev]
    uses: ./.github/workflows/push.yml
    with:
      service: "incollab"
      dockerfile_path: "./Dockerfile"
      context_path: "."
      image_tag: "dev"
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  incollab-deploy-staging:
    name: Deploy Incollab to Staging
    if: needs.detect-changes.outputs.incollab == 'true' && github.ref == 'refs/heads/dev'
    needs: [detect-changes, incollab-push-dev]
    uses: ./.github/workflows/deploy.yml
    with:
      service: "incollab"
      environment: "staging"
      image_tag: "dev"
    secrets:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

  # Incollab Pipeline - Main Branch (Production)
  # Strategy: Promote the dev image to production (retag dev → latest)
  incollab-promote-prod:
    name: Promote Image to Production
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull dev image and retag as latest
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/incollab:dev
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/incollab:dev ${{ secrets.DOCKERHUB_USERNAME }}/incollab:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/incollab:latest
          echo "✅ Promoted dev image to latest (production)"

  incollab-deploy-production:
    name: Deploy Incollab to Production
    if: github.ref == 'refs/heads/main'
    needs: [incollab-promote-prod]
    uses: ./.github/workflows/deploy.yml
    with:
      service: "incollab"
      environment: "production"
      image_tag: "latest"
    secrets:
      EC2_HOST: ${{ secrets.PROD_EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.PROD_EC2_SSH_KEY }}

  # Summary job
  pipeline-summary:
    name: Pipeline Summary
    if: always()
    needs: [
      detect-changes,
      incollab-build-dev,
      incollab-test-dev,
      incollab-push-dev,
      incollab-deploy-staging,
      incollab-promote-prod,
      incollab-deploy-production
    ]
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline Summary
        run: |
          echo "# Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "## Changed Services" >> $GITHUB_STEP_SUMMARY
          echo "- Incollab: ${{ needs.detect-changes.outputs.incollab }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY

          echo "## Job Status" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "### Dev Pipeline" >> $GITHUB_STEP_SUMMARY
            echo "| Service | Build | Test | Push | Deploy |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-------|------|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Incollab | ${{ needs.incollab-build-dev.result || 'skipped' }} | ${{ needs.incollab-test-dev.result || 'skipped' }} | ${{ needs.incollab-push-dev.result || 'skipped' }} | ${{ needs.incollab-deploy-staging.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "### Production Pipeline (Promote Strategy)" >> $GITHUB_STEP_SUMMARY
            echo "| Service | Promote | Deploy |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Incollab | ${{ needs.incollab-promote-prod.result || 'skipped' }} | ${{ needs.incollab-deploy-production.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          fi