name: Main CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - dev

jobs:
  # Detect which services have changed
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      incollab: ${{ steps.changes.outputs.incollab }}
      # any-service: ${{ steps.changes.outputs.any-service }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper diff

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            incollab:
              - 'incollab/**'
              - 'src/**'
              - 'package.json'
              - 'Dockerfile'
              - 'docker-compose.yml'
              - 'nginx.conf'
              - '.env'
              - '.github/workflows/**'


  # Incollab Pipeline
  incollab-build:
    name: Build Incollab
    if: needs.detect-changes.outputs.incollab == 'true'
    needs: detect-changes
    uses: ./.github/workflows/build.yml
    with:
      service: "incollab"
      dockerfile_path: "./Dockerfile"
      context_path: "."

  incollab-test:
    name: Test Incollab
    if: needs.detect-changes.outputs.incollab == 'true'
    needs: [detect-changes, incollab-build]
    uses: ./.github/workflows/test.yml
    with:
      service: "incollab"
      service_path: "."
      node_version: "18"

  incollab-push:
    name: Push Incollab
    if: needs.detect-changes.outputs.incollab == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    needs: [detect-changes, incollab-test]
    uses: ./.github/workflows/push.yml
    with:
      service: "incollab"
      dockerfile_path: "./Dockerfile"
      context_path: "."
      image_tag: ${{ github.ref == 'refs/heads/main' && 'latest' || 'dev' }}
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  incollab-deploy-staging:
    name: Deploy Incollab to Staging
    if: needs.detect-changes.outputs.incollab == 'true' && github.ref == 'refs/heads/dev'
    needs: [detect-changes, incollab-push]
    uses: ./.github/workflows/deploy.yml
    with:
      service: "incollab"
      environment: "staging"
      image_tag: "dev"
    secrets:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}

  incollab-deploy-production:
    name: Deploy Incollab to Production
    if: needs.detect-changes.outputs.incollab == 'true' && github.ref == 'refs/heads/main'
    needs: [detect-changes, incollab-push]
    uses: ./.github/workflows/deploy.yml
    with:
      service: "incollab"
      environment: "production"
      image_tag: "latest"
    secrets:
      EC2_HOST: ${{ secrets.PROD_EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.PROD_EC2_SSH_KEY }}

  # Summary job
  pipeline-summary:
    name: Pipeline Summary
    if: always()
    needs: [
      detect-changes,
      incollab-build,
      incollab-test,
      incollab-push,
      incollab-deploy-staging,
      incollab-deploy-production
    ]
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline Summary
        run: |
          echo "# Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "## Changed Services" >> $GITHUB_STEP_SUMMARY
          echo "- Incollab: ${{ needs.detect-changes.outputs.incollab }}" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Build | Test | Push | Deploy Staging | Deploy Prod |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|------|------|---------------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Incollab | ${{ needs.incollab-build.result || 'skipped' }} | ${{ needs.incollab-test.result || 'skipped' }} | ${{ needs.incollab-push.result || 'skipped' }} | ${{ needs.incollab-deploy-staging.result || 'skipped' }} | ${{ needs.incollab-deploy-production.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY